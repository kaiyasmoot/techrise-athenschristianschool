This is code from Tyler Hurt.

Brian Whigham contributed by merging in some neopixel and TRsim logic that appears not to be working.